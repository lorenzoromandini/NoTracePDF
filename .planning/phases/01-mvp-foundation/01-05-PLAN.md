---
phase: 01-mvp-foundation
plan: 05
type: execute
wave: 2
depends_on: [01-01, 01-02]
files_modified: []
autonomous: true
requirements: [PDF-14, PDF-15, PDF-16]

must_haves:
  truths:
    - "User can extract text from PDF"
    - "User can extract images from PDF"
    - "User can extract pages from PDF as separate files"
  artifacts:
    - path: "app/services/pdf_extract_service.py"
      provides: "PDF extraction operations"
      exports: ["extract_text", "extract_images", "extract_pages"]
    - path: "app/api/v1/pdf.py"
      provides: "Updated API endpoints"
      contains: "extract"
    - path: "requirements.txt"
      provides: "PyMuPDF dependency"
      contains: "PyMuPDF"
  key_links:
    - from: "app/services/pdf_extract_service.py"
      to: "PyMuPDF (fitz)"
      via: "text and image extraction"
      pattern: "import fitz"
    - from: "app/api/v1/pdf.py"
      to: "app/services/pdf_extract_service.py"
      via: "service import"
      pattern: "from app.services.pdf_extract_service import"
---

<objective>
Implement PDF extraction features (text, images, pages) using PyMuPDF for high-performance in-memory processing.

Purpose: Extraction capabilities are essential for users who need to repurpose content from PDFs. Must maintain zero-trace with in-memory processing.

Output: Working PDF extraction module with REST API endpoints for text, images, and pages.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/research/PITFALLS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PyMuPDF dependency and create extraction service</name>
  <files>
    requirements.txt
    app/services/pdf_extract_service.py
    app/schemas/pdf.py
  </files>
  <action>
    Set up PDF extraction infrastructure with PyMuPDF:

    1. Update `requirements.txt`:
       - PyMuPDF==1.25.0

    2. Update `app/schemas/pdf.py`:
       - ExtractTextRequest: pages (optional: list[int] or "all")
       - ExtractTextResponse: text (str), pages (list of {page_num, text})
       - ExtractImagesRequest: pages (optional), format (enum: png, jpg, original)
       - ExtractPagesRequest: pages (list[int])

    3. Create `app/services/pdf_extract_service.py`:
       - extract_text(file: BytesIO, pages: list[int] = None) -> dict
         - Use fitz.open(stream=bytes_data) for in-memory access
         - Extract text from specified pages or all pages
         - Return structured dict with page-by-page text
         - Handle PDFs without text (scanned docs return empty)
       - extract_images(file: BytesIO, pages: list[int] = None, format: str = "original") -> list[tuple[str, BytesIO]]
         - Extract all images from specified pages
         - Convert to specified format if needed
         - Return list of (filename, BytesIO) tuples
       - extract_pages(file: BytesIO, pages: list[int]) -> list[tuple[str, BytesIO]]
         - Extract specified pages as separate PDF files
         - Return list of (filename, BytesIO) tuples

    Note: PyMuPDF (fitz) has excellent BytesIO support: fitz.open(stream=bytes_data)

    Reference STACK.md for PyMuPDF in-memory pattern.
  </action>
  <verify>
    pip install PyMuPDF==1.25.0 -q && python -c "
import fitz
from app.services.pdf_extract_service import extract_text, extract_images, extract_pages
print('PyMuPDF and extraction functions exist')
"
  </verify>
  <done>
    - PyMuPDF added to requirements.txt
    - extract_text function extracts text from PDF
    - extract_images function extracts images from PDF
    - extract_pages function creates separate PDFs from pages
    - All functions work in-memory
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement text extraction with formatting preservation</name>
  <files>
    app/services/pdf_extract_service.py
  </files>
  <action>
    Enhance text extraction functionality:

    1. Update extract_text in `app/services/pdf_extract_service.py`:
       - Extract text with layout preservation option
       - Handle different text encodings
       - Include metadata: page numbers, character count
       - Option to extract as plain text or with formatting markers

    2. Add text processing utilities:
       - clean_text(text: str) -> str
         - Remove excessive whitespace
         - Normalize line endings
         - Handle special characters

    3. Create response structure:
       ```python
       {
         "total_pages": int,
         "total_characters": int,
           "pages": [
             {
               "page_number": int,
               "text": str,
               "character_count": int
             }
           ]
       }
       ```

    4. Handle edge cases:
       - PDF with no text (scanned document)
       - Corrupted text encoding
       - Very large text content

    Reference PDF-14: Extract text from PDF.
  </action>
  <verify>
    python -c "
from app.services.pdf_extract_service import extract_text, clean_text
print('Text extraction functions work')
"
  </verify>
  <done>
    - Text extraction preserves layout
    - Page-by-page extraction supported
    - Metadata included in response
    - Edge cases handled gracefully
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement image extraction with format conversion</name>
  <files>
    app/services/pdf_extract_service.py
    app/utils/file_utils.py
  </files>
  <action>
    Enhance image extraction functionality:

    1. Update extract_images in `app/services/pdf_extract_service.py`:
       - Extract images at original resolution
       - Support format conversion: original, png, jpg
       - Generate sequential filenames: image_001.png, image_002.png
       - Handle embedded images with different colorspaces

    2. Use PyMuPDF image extraction:
       - Access images via page.get_images()
       - Extract via pdf.extractImage(xref)
       - Convert format using Pillow if needed

    3. Handle edge cases:
       - PDFs with no images
       - Images with unusual colorspaces (CMYK, etc.)
       - Very large images (apply size limits)

    4. Return structure for ZIP packaging:
       - List of (filename, BytesIO) tuples
       - Each tuple ready for ZIP archive inclusion

    Reference PDF-15: Extract images from PDF.
  </action>
  <verify>
    python -c "
from app.services.pdf_extract_service import extract_images
print('Image extraction function works')
"
  </verify>
  <done>
    - Images extracted at original resolution
    - Format conversion supported
    - Sequential filenames generated
    - Edge cases handled
  </done>
</task>

<task type="auto">
  <name>Task 4: Create REST API endpoints for extraction operations</name>
  <files>
    app/api/v1/pdf.py
  </files>
  <action>
    Add API endpoints for extraction operations:

    1. Add to `app/api/v1/pdf.py`:
       - POST /api/v1/pdf/extract/text
         - Accept file + optional pages parameter
         - Return JSON with text content
         - Content-Type: application/json
       - POST /api/v1/pdf/extract/images
         - Accept file + optional pages + format
         - Return ZIP archive of images
         - Use create_zip_archive utility
         - Content-Type: application/zip
       - POST /api/v1/pdf/extract/pages
         - Accept file + pages list
         - Return ZIP archive of individual page PDFs
         - Or single PDF if only one page extracted

    2. All endpoints:
       - Proper error handling
       - Memory-efficient streaming for large files
       - Cache-Control headers (already applied by middleware)

    Reference PDF-14, PDF-15, PDF-16 for endpoint behaviors.
  </action>
  <verify>
    python -c "
from app.api.v1.pdf import router
routes = [r.path for r in router.routes]
assert '/extract/text' in ' '.join(routes)
assert '/extract/images' in ' '.join(routes)
assert '/extract/pages' in ' '.join(routes)
print('Extraction routes exist')
"
  </verify>
  <done>
    - POST /api/v1/pdf/extract/text endpoint exists
    - POST /api/v1/pdf/extract/images endpoint exists
    - POST /api/v1/pdf/extract/pages endpoint exists
    - Text returns JSON, images/pages return ZIP
    - All operations use in-memory processing
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Test text extraction: `curl -X POST -F "file=@test.pdf" http://localhost:8000/api/v1/pdf/extract/text`
2. Test image extraction: `curl -X POST -F "file=@test.pdf" http://localhost:8000/api/v1/pdf/extract/images -o images.zip`
3. Test page extraction: `curl -X POST -F "file=@test.pdf" -F "pages=[1,2]" http://localhost:8000/api/v1/pdf/extract/pages -o pages.zip`
4. Verify extracted content is valid
</verification>

<success_criteria>
- User can extract text from PDF with page information
- User can extract images from PDF in various formats
- User can extract pages as separate PDF files
- All operations use in-memory processing
- Requirements PDF-14 to PDF-16 implemented
</success_criteria>

<output>
After completion, create `.planning/phases/01-mvp-foundation/01-05-SUMMARY.md`
</output>
