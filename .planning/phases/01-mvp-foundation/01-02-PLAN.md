---
phase: 01-mvp-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
requirements: [ARCH-02, ARCH-03, ARCH-06, ARCH-07, DEPLOY-01, DEPLOY-02, DEPLOY-03, DEPLOY-04]

must_haves:
  truths:
    - "Docker container builds successfully with Alpine base"
    - "Container has zero persistent volumes for user data"
    - "tmpfs mounts provide RAM-backed temporary storage"
    - "Container memory limits prevent OOM from affecting host"
    - "Request timeouts prevent DoS via slow uploads"
  artifacts:
    - path: "Dockerfile"
      provides: "Container image definition"
      contains: "FROM python:3.12-alpine"
    - path: "docker-compose.yml"
      provides: "Orchestration configuration"
      contains: "tmpfs:"
    - path: ".dockerignore"
      provides: "Build context optimization"
    - path: "LICENSE"
      provides: "MIT or AGPLv3 license"
  key_links:
    - from: "docker-compose.yml"
      to: "Dockerfile"
      via: "build context"
      pattern: "build: \\."
    - from: "docker-compose.yml"
      to: "/tmp"
      via: "tmpfs mount"
      pattern: "tmpfs:.*- /tmp"
---

<objective>
Create Docker infrastructure that guarantees zero-persistence through tmpfs mounts, memory limits, and no volumes.

Purpose: The privacy guarantee depends on infrastructure. Files must never touch persistent storage. Docker configuration ensures this at the container level.

Output: Production-ready Docker setup with tmpfs, memory limits, timeouts, and no persistent volumes.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/research/PITFALLS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile with Alpine base and minimal footprint</name>
  <files>
    Dockerfile
    .dockerignore
  </files>
  <action>
    Create production-ready Dockerfile optimized for zero-persistence:

    1. Create `Dockerfile`:
       - Base: `python:3.12-alpine` (smallest attack surface)
       - Create non-root user: `appuser`
       - Copy requirements.txt and install dependencies
       - Copy application code
       - Set working directory: /app
       - Expose port 8000
       - Run as non-root user
       - DO NOT include VOLUME instruction (violates ARCH-02)
       - ENTRYPOINT: gunicorn app.main:app -w 2 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000

    2. Create `.dockerignore`:
       - Exclude: .git, .planning, __pycache__, *.pyc, .env, .venv, venv, node_modules
       - Include only necessary files

    3. Add gunicorn to requirements.txt if not present:
       - gunicorn==23.0.0

    Key constraint: NO VOLUME instruction. NO persistent storage paths. All temporary files must go to tmpfs-mounted directories.

    Reference PITFALLS.md "Docker Volume Persistence" - this is a critical security requirement.
  </action>
  <verify>
    grep -q "FROM python:3.12-alpine" Dockerfile && grep -q "VOLUME" Dockerfile && echo "ERROR: VOLUME found" || echo "No VOLUME instruction (correct)"
  </verify>
  <done>
    - Dockerfile uses python:3.12-alpine base
    - No VOLUME instruction present
    - Runs as non-root user
    - .dockerignore excludes unnecessary files
    - Docker image builds successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Create docker-compose with tmpfs mounts and resource limits</name>
  <files>
    docker-compose.yml
    docker-compose.dev.yml
  </files>
  <action>
    Create docker-compose configuration with zero-persistence guarantees:

    1. Create `docker-compose.yml` (production):
       - Service: notracepdf
       - Build: current directory
       - Ports: "8000:8000"
       - tmpfs mounts:
         - /tmp:noexec,nosuid,size=512m
         - /app/uploads:noexec,nosuid,size=256m
       - Environment:
         - UPLOAD_DIR=/app/uploads
         - DEBUG=false
       - Resource limits:
         - mem_limit: 1g (adjustable)
         - cpus: 2
       - Read_only: false (tmpfs needs write permission)
       - NO volumes: section (empty or omitted)
       - Restart: unless-stopped

    2. Create `docker-compose.dev.yml` (development override):
       - Mount source code for hot reload
       - Debug mode enabled
       - Same tmpfs mounts

    Critical: NO volumes: section with persistent storage. tmpfs is RAM-backed and ephemeral.

    Reference ARCH-02, ARCH-03: Zero persistent volumes, tmpfs for temp files.
    Reference ARCH-06: Memory limits prevent host OOM.
  </action>
  <verify>
    grep -q "tmpfs:" docker-compose.yml && grep -q "size=" docker-compose.yml && grep -q "volumes:" docker-compose.yml && echo "ERROR: volumes section found" || echo "No persistent volumes (correct)"
  </verify>
  <done>
    - docker-compose.yml has tmpfs mounts for /tmp and /app/uploads
    - tmpfs has size limits (512m for /tmp, 256m for uploads)
    - No persistent volumes defined
    - Memory limits configured
    - Docker compose configuration validates
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure request timeouts and connection limits</name>
  <files>
    app/core/config.py
    Dockerfile
    docker-compose.yml
  </files>
  <action>
    Add request timeout configuration to prevent DoS:

    1. Update `app/core/config.py`:
       - Add: REQUEST_TIMEOUT_SECONDS (default: 30)
       - Add: MAX_UPLOAD_SIZE_BYTES (computed from MAX_FILE_SIZE_MB)

    2. Update `Dockerfile` ENTRYPOINT:
       - Add gunicorn timeout: --timeout 30
       - Add gunicorn graceful timeout: --graceful-timeout 10
       - Full command: gunicorn app.main:app -w 2 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000 --timeout 30 --graceful-timeout 10

    3. Update `docker-compose.yml`:
       - Add environment: REQUEST_TIMEOUT_SECONDS=30
       - Add healthcheck endpoint

    Reference ARCH-07: Request timeouts prevent DoS via slow uploads.
    Reference PITFALLS.md "Memory Exhaustion" - timeouts are part of the defense.
  </action>
  <verify>
    grep -q "REQUEST_TIMEOUT" app/core/config.py && grep -q "timeout" Dockerfile && grep -q "REQUEST_TIMEOUT" docker-compose.yml
  </verify>
  <done>
    - REQUEST_TIMEOUT_SECONDS configured in Settings
    - Gunicorn timeout set to 30 seconds
    - Graceful timeout set for clean shutdown
    - Environment variable exposed in docker-compose
  </done>
</task>

<task type="auto">
  <name>Task 4: Add MIT license and deployment documentation</name>
  <files>
    LICENSE
    README.md
  </files>
  <action>
    Create license and basic deployment documentation:

    1. Create `LICENSE`:
       - MIT License (standard text)
       - Copyright holder: NoTracePDF contributors

    2. Create `README.md`:
       - Project description
       - Quick start:
         ```bash
         docker-compose up -d
         ```
       - Access: http://localhost:8000
       - Zero-trace guarantee explanation
       - Configuration options
       - Security notes about tmpfs and no persistence

    Reference DEPLOY-03: MIT or AGPLv3 license required.
    Reference DEPLOY-04: Must run on NAS/VPS/home lab.
  </action>
  <verify>
    test -f LICENSE && test -f README.md && head -1 LICENSE | grep -qi "mit"
  </verify>
  <done>
    - LICENSE file exists with MIT license
    - README.md documents quick start with docker-compose
    - Zero-trace guarantee is explained
    - Configuration options documented
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Build image: `docker build -t notracepdf .`
2. Verify no VOLUME: `docker inspect notracepdf | grep -i volume`
3. Start container: `docker-compose up -d`
4. Check tmpfs mounts: `docker exec notracepdf mount | grep tmpfs`
5. Verify memory limits: `docker stats --no-stream notracepdf`
6. Test health: `curl http://localhost:8000/health`
7. Stop and verify no persistent data: `docker-compose down && docker volume ls`
</verification>

<success_criteria>
- Docker image builds successfully with Alpine base
- No VOLUME instruction in Dockerfile
- tmpfs mounts configured for /tmp and /app/uploads
- Memory limits prevent host OOM
- Request timeouts configured
- MIT license included
- Single docker-compose up deploys the application
- Requirements ARCH-02, ARCH-03, ARCH-06, ARCH-07, DEPLOY-01 to DEPLOY-04 implemented
</success_criteria>

<output>
After completion, create `.planning/phases/01-mvp-foundation/01-02-SUMMARY.md`
</output>
