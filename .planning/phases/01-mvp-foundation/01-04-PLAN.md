---
phase: 01-mvp-foundation
plan: 04
type: execute
wave: 2
depends_on: [01-01, 01-02]
files_modified: []
autonomous: true
requirements: [PDF-08, PDF-09, PDF-10, PDF-11, PDF-12, PDF-13]

must_haves:
  truths:
    - "User can compress PDF with quality presets (low/medium/high)"
    - "User can add password protection with open password"
    - "User can set PDF permissions (print, copy, edit)"
    - "User can remove password protection with valid password"
    - "User can add text watermark with positioning options"
    - "User can add image watermark with positioning options"
  artifacts:
    - path: "app/services/pdf_security_service.py"
      provides: "PDF security and compression operations"
      exports: ["compress_pdf", "add_password", "remove_password", "set_permissions"]
    - path: "app/services/pdf_watermark_service.py"
      provides: "PDF watermark operations"
      exports: ["add_text_watermark", "add_image_watermark"]
    - path: "app/api/v1/pdf.py"
      provides: "Updated API endpoints"
      contains: "compress", "password", "watermark"
  key_links:
    - from: "app/api/v1/pdf.py"
      to: "app/services/pdf_security_service.py"
      via: "service import"
      pattern: "from app.services.pdf_security_service import"
    - from: "app/services/pdf_security_service.py"
      to: "pikepdf"
      via: "encryption and compression"
      pattern: "pikepdf\\.(Password|Encryption|compress)"
---

<objective>
Implement PDF security features (compress, password, permissions) and watermark capabilities using pikepdf with in-memory processing.

Purpose: Security and enhancement features users expect from a professional PDF toolkit. All operations maintain zero-trace guarantee.

Output: Working PDF security and watermark module with REST API endpoints.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/research/PITFALLS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PDF compression with quality presets</name>
  <files>
    app/services/pdf_security_service.py
    app/schemas/pdf.py
  </files>
  <action>
    Create PDF compression functionality:

    1. Update `app/schemas/pdf.py`:
       - CompressRequest: quality (enum: low, medium, high)
       - Quality preset definitions:
         - low: 72 DPI, aggressive image compression
         - medium: 150 DPI, balanced compression
         - high: 300 DPI, minimal compression

    2. Create `app/services/pdf_security_service.py`:
       - compress_pdf(file: BytesIO, quality: str) -> BytesIO
         - Use pikepdf's image recompression
         - Apply DPI scaling based on quality preset
         - Downsample images to target DPI
         - Use appropriate JPEG/WebP quality for images
         - Return compressed PDF as BytesIO

    3. Implementation notes for pikepdf:
       - Access page images via page.Resources
       - Recompress with appropriate quality settings
       - Handle both JPEG and other image formats
       - Preserve PDF structure and non-image content

    Reference PDF-08: Compression with quality presets.
  </action>
  <verify>
    python -c "
from app.services.pdf_security_service import compress_pdf
from app.schemas.pdf import CompressRequest
print('Compression function exists')
"
  </verify>
  <done>
    - compress_pdf function works with BytesIO
    - Three quality presets available (low/medium/high)
    - Compression reduces file size appropriately
    - PDF structure preserved
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement password protection and permission settings</name>
  <files>
    app/services/pdf_security_service.py
    app/schemas/pdf.py
  </files>
  <action>
    Create password and permission functionality:

    1. Update `app/schemas/pdf.py`:
       - PasswordRequest: password (str), permissions (optional: list[str])
       - Permission options: "print", "copy", "edit", "annotate", "fill_forms", "extract"
       - RemovePasswordRequest: password (str)

    2. Add to `app/services/pdf_security_service.py`:
       - add_password(file: BytesIO, password: str, permissions: list[str] = None) -> BytesIO
         - Use pikepdf encryption: pikepdf.Encryption(owner=password, user=password)
         - Set permissions based on input
         - Return encrypted PDF as BytesIO
       - remove_password(file: BytesIO, password: str) -> BytesIO
         - Open PDF with password: pikepdf.Pdf.open(stream, password=password)
         - Save without encryption
         - Return decrypted PDF as BytesIO
       - set_permissions(file: BytesIO, password: str, permissions: list[str]) -> BytesIO
         - Modify existing permissions
         - Return modified PDF as BytesIO

    3. Permission mapping for pikepdf:
       - print: permit_printing
       - copy: permit_copy
       - edit: permit_modify
       - annotate: permit_modify_annotations
       - fill_forms: permit_fill_forms
       - extract: permit_extract

    Reference PDF-09, PDF-10, PDF-11: Password protection, permissions, and removal.
  </action>
  <verify>
    python -c "
from app.services.pdf_security_service import add_password, remove_password, set_permissions
from app.schemas.pdf import PasswordRequest, RemovePasswordRequest
print('Password functions exist')
"
  </verify>
  <done>
    - add_password creates encrypted PDF with open password
    - Permissions can be set (print, copy, edit, etc.)
    - remove_password decrypts PDF with valid password
    - All operations work in-memory
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement text watermark functionality</name>
  <files>
    app/services/pdf_watermark_service.py
    app/schemas/pdf.py
  </files>
  <action>
    Create text watermark functionality:

    1. Update `app/schemas/pdf.py`:
       - TextWatermarkRequest:
         - text (str): watermark text
         - font_size (int, default: 48)
         - color (str, default: "#808080"): hex color
         - opacity (float, default: 0.3): 0.0 to 1.0
         - position (enum: center, diagonal, top-left, top-right, bottom-left, bottom-right)
         - pages (enum: all, first, last, or list of page numbers)

    2. Create `app/services/pdf_watermark_service.py`:
       - add_text_watermark(file: BytesIO, params: TextWatermarkRequest) -> BytesIO
         - Use pikepdf to add watermark content to pages
         - Calculate position based on page size and position enum
         - For diagonal: calculate angle based on page dimensions
         - Apply opacity via transparency settings
         - Return watermarked PDF as BytesIO

    3. Position calculations:
       - center: middle of page
       - diagonal: from bottom-left to top-right at ~45Â°
       - corners: respective corners with margin

    Note: pikepdf supports adding content streams to pages for watermarks.

    Reference PDF-12: Text watermark with positioning options.
  </action>
  <verify>
    python -c "
from app.services.pdf_watermark_service import add_text_watermark
from app.schemas.pdf import TextWatermarkRequest
print('Text watermark function exists')
"
  </verify>
  <done>
    - add_text_watermark applies text watermark to PDF
    - Multiple position options work (center, diagonal, corners)
    - Opacity and color configurable
    - Works on specified pages or all pages
  </done>
</task>

<task type="auto">
  <name>Task 4: Implement image watermark functionality</name>
  <files>
    app/services/pdf_watermark_service.py
    app/schemas/pdf.py
  </files>
  <action>
    Create image watermark functionality:

    1. Update `app/schemas/pdf.py`:
       - ImageWatermarkRequest:
         - image (UploadFile): watermark image file
         - opacity (float, default: 0.3)
         - position (enum: center, diagonal, top-left, top-right, bottom-left, bottom-right)
         - scale (float, default: 0.5): relative to page size
         - pages (enum: all, first, or list)

    2. Add to `app/services/pdf_watermark_service.py`:
       - add_image_watermark(file: BytesIO, image: BytesIO, params: ImageWatermarkRequest) -> BytesIO
         - Read watermark image (support PNG with transparency)
         - Calculate position and scale based on page dimensions
         - Embed image as XObject in PDF
         - Add to specified pages
         - Return watermarked PDF as BytesIO

    3. Implementation approach:
       - Use pikepdf to add image XObject to PDF
       - Create content stream that draws the image
       - Apply transparency via graphics state

    4. Update requirements.txt if needed:
       - Pillow already included for image handling

    Reference PDF-13: Image watermark with positioning options.
  </action>
  <verify>
    python -c "
from app.services.pdf_watermark_service import add_image_watermark
from app.schemas.pdf import ImageWatermarkRequest
print('Image watermark function exists')
"
  </verify>
  <done>
    - add_image_watermark applies image watermark to PDF
    - Supports PNG with transparency
    - Position and scale configurable
    - Works on specified pages
    - All processing in-memory
  </done>
</task>

<task type="auto">
  <name>Task 5: Create REST API endpoints for security and watermarks</name>
  <files>
    app/api/v1/pdf.py
  </files>
  <action>
    Add API endpoints for security and watermark operations:

    1. Add to `app/api/v1/pdf.py`:
       - POST /api/v1/pdf/compress
         - Accept file + quality parameter
         - Return compressed PDF
       - POST /api/v1/pdf/password/add
         - Accept file + password + optional permissions
         - Return encrypted PDF
       - POST /api/v1/pdf/password/remove
         - Accept file + password
         - Return decrypted PDF
       - POST /api/v1/pdf/watermark/text
         - Accept file + watermark parameters
         - Return watermarked PDF
       - POST /api/v1/pdf/watermark/image
         - Accept file (PDF) + image file + parameters
         - Return watermarked PDF

    2. All endpoints:
       - Use StreamingResponse for returns
       - Proper Content-Disposition headers
       - Error handling for invalid passwords
       - Handle file validation

    Reference PDF-08 to PDF-13 for endpoint behaviors.
  </action>
  <verify>
    python -c "
from app.api.v1.pdf import router
routes = [r.path for r in router.routes]
assert '/compress' in ' '.join(routes)
assert '/password' in ' '.join(routes)
assert '/watermark' in ' '.join(routes)
print('Security and watermark routes exist')
"
  </verify>
  <done>
    - POST /api/v1/pdf/compress endpoint exists
    - POST /api/v1/pdf/password/add endpoint exists
    - POST /api/v1/pdf/password/remove endpoint exists
    - POST /api/v1/pdf/watermark/text endpoint exists
    - POST /api/v1/pdf/watermark/image endpoint exists
    - All endpoints return StreamingResponse
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Test compress: `curl -X POST -F "file=@test.pdf" -F "quality=medium" http://localhost:8000/api/v1/pdf/compress -o compressed.pdf`
2. Test password add: `curl -X POST -F "file=@test.pdf" -F "password=secret123" http://localhost:8000/api/v1/pdf/password/add -o encrypted.pdf`
3. Test password remove: `curl -X POST -F "file=@encrypted.pdf" -F "password=secret123" http://localhost:8000/api/v1/pdf/password/remove -o decrypted.pdf`
4. Test text watermark: `curl -X POST -F "file=@test.pdf" -F "text=DRAFT" -F "position=diagonal" http://localhost:8000/api/v1/pdf/watermark/text -o watermarked.pdf`
5. Test image watermark: `curl -X POST -F "file=@test.pdf" -F "image=@logo.png" http://localhost:8000/api/v1/pdf/watermark/image -o watermarked.pdf`
</verification>

<success_criteria>
- User can compress PDF with quality presets
- User can add and remove password protection
- User can set PDF permissions
- User can add text watermarks with positioning
- User can add image watermarks
- All operations use in-memory processing
- Requirements PDF-08 to PDF-13 implemented
</success_criteria>

<output>
After completion, create `.planning/phases/01-mvp-foundation/01-04-SUMMARY.md`
</output>
