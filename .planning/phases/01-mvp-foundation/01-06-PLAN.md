---
phase: 01-mvp-foundation
plan: 06
type: execute
wave: 2
depends_on: [01-01, 01-02]
files_modified: []
autonomous: true
requirements: [IMG-01, IMG-02, IMG-03, IMG-04, IMG-05, IMG-06]

must_haves:
  truths:
    - "User can convert PDF pages to PNG images"
    - "User can convert PDF pages to JPG images"
    - "User can convert PDF pages to WebP images"
    - "User can convert single PDF page or all pages"
    - "User can convert multiple images into single PDF"
    - "User can specify page sizing when creating PDF from images"
  artifacts:
    - path: "app/services/image_service.py"
      provides: "Image conversion operations"
      exports: ["pdf_to_images", "images_to_pdf"]
    - path: "app/api/v1/image.py"
      provides: "Image conversion API endpoints"
      exports: ["router"]
    - path: "requirements.txt"
      provides: "Image dependencies"
      contains: "pdf2image"
  key_links:
    - from: "app/services/image_service.py"
      to: "pdf2image"
      via: "PDF to image conversion"
      pattern: "from pdf2image import convert_from_bytes"
    - from: "app/services/image_service.py"
      to: "Pillow"
      via: "Image manipulation"
      pattern: "from PIL import Image"
    - from: "app/api/v1/image.py"
      to: "app/services/image_service.py"
      via: "service import"
      pattern: "from app.services.image_service import"
---

<objective>
Implement bidirectional PDF-to-image and image-to-PDF conversion with multiple format support using Pillow and pdf2image.

Purpose: Image conversion is a core feature users expect. Must support PNG, JPG, WebP for output and multiple images for PDF creation.

Output: Working image conversion module with REST API endpoints, all processing in-memory.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PITFALLS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add image dependencies and create image service</name>
  <files>
    requirements.txt
    app/services/image_service.py
    app/schemas/image.py
    Dockerfile
  </files>
  <action>
    Set up image conversion infrastructure:

    1. Update `requirements.txt`:
       - pdf2image==1.17.0

    2. Update `Dockerfile` to add poppler-utils:
       - Add to apk add: poppler-utils
       - This is required by pdf2image for PDF rendering

    3. Create `app/schemas/image.py`:
       - PdfToImageRequest:
         - format (enum: png, jpg, webp)
         - pages (enum: all, first, or list[int])
         - dpi (int, default: 200)
         - quality (int, default: 85, for jpg/webp)
       - ImageToPdfRequest:
         - page_size (enum: a4, letter, fit, original)
         - margin (int, default: 0)
         - fit_to_page (bool, default: true)

    4. Create `app/services/image_service.py`:
       - pdf_to_images(file: BytesIO, format: str, pages, dpi: int, quality: int) -> list[tuple[str, BytesIO]]
         - Use convert_from_bytes from pdf2image
         - Convert specified pages to images
         - Apply DPI and quality settings
         - Return list of (filename, BytesIO) tuples
       - images_to_pdf(files: list[BytesIO], page_size: str, margin: int, fit: bool) -> BytesIO
         - Create PDF from multiple images
         - Apply page sizing and margins
         - Return PDF as BytesIO

    Reference STACK.md for pdf2image BytesIO pattern.
  </action>
  <verify>
    pip install pdf2image==1.17.0 -q && python -c "
from app.services.image_service import pdf_to_images, images_to_pdf
from app.schemas.image import PdfToImageRequest, ImageToPdfRequest
print('Image service functions exist')
"
  </verify>
  <done>
    - pdf2image added to requirements.txt
    - poppler-utils in Dockerfile
    - pdf_to_images converts PDF pages to images
    - images_to_pdf creates PDF from images
    - All functions work in-memory
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement PDF to image conversion with format support</name>
  <files>
    app/services/image_service.py
  </files>
  <action>
    Implement comprehensive PDF to image conversion:

    1. Update pdf_to_images in `app/services/image_service.py`:
       - Support page selection:
         - "all": convert all pages
         - "first": convert only first page
         - [1, 3, 5]: convert specific pages
       - Format handling:
         - PNG: lossless, supports transparency
         - JPG: lossy, smaller files, quality setting
         - WebP: modern format, good compression
       - DPI scaling:
         - 72: low quality, small size
         - 150: medium quality
         - 200: default, good quality
         - 300: high quality, large size

    2. Implementation:
       ```python
       from pdf2image import convert_from_bytes
       
       def pdf_to_images(pdf_bytes, format='png', pages='all', dpi=200, quality=85):
           # Convert bytes to images
           images = convert_from_bytes(
               pdf_bytes.read(),
               dpi=dpi,
               thread_count=2  # Use multiple threads for speed
           )
           
           # Filter pages if needed
           # Convert to target format
           # Return list of (filename, BytesIO)
       ```

    3. Filename generation:
       - page_001.png, page_002.png, etc.
       - Or single file if only one page

    Reference IMG-01 to IMG-04: PDF to image conversion requirements.
  </action>
  <verify>
    python -c "
from app.services.image_service import pdf_to_images
# Test format parameter exists
import inspect
sig = inspect.signature(pdf_to_images)
assert 'format' in str(sig)
assert 'dpi' in str(sig)
print('pdf_to_images has format and dpi parameters')
"
  </verify>
  <done>
    - PDF pages convert to PNG
    - PDF pages convert to JPG with quality setting
    - PDF pages convert to WebP
    - Page selection works (all, first, specific)
    - DPI setting affects output quality
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement image to PDF conversion with page sizing</name>
  <files>
    app/services/image_service.py
  </files>
  <action>
    Implement image to PDF conversion:

    1. Update images_to_pdf in `app/services/image_service.py`:
       - Accept multiple image files
       - Support formats: PNG, JPG, WebP, GIF, BMP
       - Page sizing options:
         - a4: 210x297mm (standard European)
         - letter: 8.5x11in (standard US)
         - fit: size to largest image
         - original: each page sized to its image
       - Margin handling: add whitespace around images
       - Fit options:
         - fit_to_page=True: scale image to fit page
         - fit_to_page=False: center at original size

    2. Implementation approach using pikepdf:
       - Create new PDF with pikepdf.Pdf.new()
       - For each image:
         - Create a page with target dimensions
         - Embed image as XObject
         - Add content stream to draw image
       - Return PDF as BytesIO

    3. Alternative using Pillow + pikepdf:
       - Convert images to consistent format
       - Use pikepdf to create pages with images

    Reference IMG-05, IMG-06: Image to PDF conversion with page sizing.
  </action>
  <verify>
    python -c "
from app.services.image_service import images_to_pdf
import inspect
sig = inspect.signature(images_to_pdf)
assert 'page_size' in str(sig)
assert 'margin' in str(sig)
print('images_to_pdf has page_size and margin parameters')
"
  </verify>
  <done>
    - Multiple images combine into single PDF
    - A4 and Letter page sizes supported
    - Fit and original sizing options work
    - Margin adds whitespace around images
    - Works with PNG, JPG, WebP, GIF, BMP
  </done>
</task>

<task type="auto">
  <name>Task 4: Create REST API endpoints for image conversion</name>
  <files>
    app/api/v1/__init__.py
    app/api/v1/image.py
    app/main.py
  </files>
  <action>
    Create API endpoints for image conversion:

    1. Create `app/api/v1/image.py`:
       - POST /api/v1/image/pdf-to-images
         - Accept file (PDF) + format + pages + dpi + quality
         - Return ZIP archive if multiple images
         - Return single image if single page
         - Content-Type: application/zip or image/*
       - POST /api/v1/image/images-to-pdf
         - Accept multiple image files + page_size + margin + fit
         - Return PDF
         - Content-Type: application/pdf

    2. Update `app/api/v1/__init__.py`:
       - Include image router in api_router

    3. Endpoint details:
       - pdf-to-images:
         - If pages="all" and multiple pages → ZIP
         - If pages="first" or single page → single image
         - Use create_zip_archive utility for ZIP
       - images-to-pdf:
         - Accept files as list: files=@img1.png&files=@img2.jpg
         - Return PDF with sensible filename

    Reference IMG-01 to IMG-06 for endpoint behaviors.
  </action>
  <verify>
    python -c "
from app.api.v1.image import router
routes = [r.path for r in router.routes]
assert 'pdf-to-images' in ' '.join(routes)
assert 'images-to-pdf' in ' '.join(routes)
print('Image conversion routes exist')
" && grep -q "image" app/api/v1/__init__.py
  </verify>
  <done>
    - POST /api/v1/image/pdf-to-images endpoint exists
    - POST /api/v1/image/images-to-pdf endpoint exists
    - Both endpoints work in-memory
    - ZIP returned for multiple images
    - Single image returned for single page
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Test PDF to PNG: `curl -X POST -F "file=@test.pdf" -F "format=png" http://localhost:8000/api/v1/image/pdf-to-images -o images.zip`
2. Test PDF to JPG: `curl -X POST -F "file=@test.pdf" -F "format=jpg" -F "pages=first" http://localhost:8000/api/v1/image/pdf-to-images -o image.jpg`
3. Test images to PDF: `curl -X POST -F "files=@img1.png" -F "files=@img2.jpg" -F "page_size=a4" http://localhost:8000/api/v1/image/images-to-pdf -o output.pdf`
4. Verify output files are valid
</verification>

<success_criteria>
- User can convert PDF pages to PNG images
- User can convert PDF pages to JPG images with quality control
- User can convert PDF pages to WebP images
- User can select specific pages or all pages
- User can convert multiple images to PDF
- User can specify page sizing (A4, Letter, fit, original)
- All operations use in-memory processing
- Requirements IMG-01 to IMG-06 implemented
</success_criteria>

<output>
After completion, create `.planning/phases/01-mvp-foundation/01-06-SUMMARY.md`
</output>
